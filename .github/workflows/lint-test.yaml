name: Lint & Test Charts

on:
  pull_request:
    branches:
      - main
    paths:
      - "charts/**"

jobs:
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0
        with:
          fetch-depth: 0

      - name: Set-up Python
        uses: actions/setup-python@2c3dd9e7e29afd70cc0950079bde6c979d1f69f9 # v4.3.1
        with:
          python-version: "3.x"

      - name: Set-up Helm
        uses: azure/setup-helm@f382f75448129b3be48f8121b9857be18d815a82 # v3.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: latest

      - name: Set-up Helm Docs
        run: |
          set -euo pipefail
          curl -Lo /tmp/helm-docs.tar.gz https://github.com/norwoodj/helm-docs/releases/download/v1.11.0/helm-docs_1.11.0_Linux_x86_64.tar.gz
          tar -xzvf /tmp/helm-docs.tar.gz --directory /tmp
          mv /tmp/helm-docs /usr/local/bin/helm-docs
          chmod +x /usr/local/bin/helm-docs
          rm -f /tmp/helm-docs.tar.gz

      - name: Set-up Artifact Hub CLI
        run: |
          set -euo pipefail
          curl -Lo /tmp/ah.tar.gz https://github.com/artifacthub/hub/releases/download/v1.11.0/ah_1.11.0_linux_amd64.tar.gz
          tar -xzvf /tmp/ah.tar.gz --directory /tmp
          mv /tmp/ah /usr/local/bin/ah
          chmod +x /usr/local/bin/ah
          rm -f /tmp/ah.tar.gz

      - name: Set-up chart-testing
        uses: helm/chart-testing-action@afea100a513515fbd68b0e72a7bb0ae34cb62aec # v2.3.1

      - name: Check for changes
        id: changes
        run: |
          set -euo pipefail
          changed="$(ct list-changed --config ct.yaml)"
          if [[ -n "${changed}" ]]
          then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Helm Docs check
        if: fromJSON(steps.changes.outputs.changed)
        run: |
          set -euo pipefail
          helm-docs
          if [[ -n "$(git status --porcelain --untracked-files=no)" ]]
          then
            echo "Documentation not up to date. Please run helm-docs and commit changes!" >&2
            exit 1
          fi

      - name: Run Artifact Hub lint
        if: fromJSON(steps.changes.outputs.changed)
        run: ah lint --kind helm || exit 1

      - name: Run chart-testing lint
        if: fromJSON(steps.changes.outputs.changed)
        run: ct lint --config ct.yaml

      - name: Create Kind cluster
        if: fromJSON(steps.changes.outputs.changed)
        uses: helm/kind-action@d8ccf8fb623ce1bb360ae2f45f323d9d5c5e9f00 # v1.5.0
        with:
          node_image: kindest/node:v1.24.6

      - name: Run chart-testing install
        if: fromJSON(steps.changes.outputs.changed)
        run: ct install --config ct.yaml
