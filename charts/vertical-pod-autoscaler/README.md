# Vertical Pod Autoscaler Helm Chart

The [Vertical Pod Autoscaler](https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler/) (VPA) frees the users from necessity of setting up-to-date resource limits and requests for the containers in their pods. When configured, it will set the requests automatically based on usage and thus allow proper scheduling onto nodes so that appropriate resource amount is available for each pod. It will also maintain ratios between limits and requests that were specified in initial containers configuration.

It can both down-scale pods that are over-requesting resources, and also up-scale pods that are under-requesting resources based on their usage over time.

Autoscaling is configured with a `CustomResourceDefinition` object called `VerticalPodAutoscaler`. It allows to specify which pods should be vertically autoscaled as well as if/how the resource recommendations are applied.

This chart manages the `MutatingWebhookConfiguration` outside of the workload so there is no need to run additional logic to clean-up after VPA is uninstalled, webhook certificates can also be managed by [Cert Manager](https://cert-manager.io/docs/). The chart handles the parameters for logging levels and ports but all other parameters need to be passed in to the components.

- [Recommender parameters](https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/FAQ.md#what-are-the-parameters-to-vpa-recommender)
- [Updater parameters](https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/FAQ.md#what-are-the-parameters-to-vpa-updater)

To enable vertical pod autoscaling on your cluster please follow the installation procedure described below.

## Installing the Chart

Before you can install the chart you will need to add the `stevehipwell` repo to [Helm](https://helm.sh/).

```shell
helm repo add stevehipwell https://stevehipwell.github.io/helm-charts/
```

After you've installed the repo you can install the chart.

```shell
helm upgrade --install --namespace kube-system vertical-pod-autoscaler stevehipwell/vertical-pod-autoscaler
```

## Configuration

The following table lists the configurable parameters of the _Vertical Pod Autoscaler_ Helm chart and their default values.

| Parameter                                                | Description                                                                                                                                                                                      | Default                                  |
| -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------- |
| `imagePullSecrets`                                       | Image pull secrets.                                                                                                                                                                              | `[]`                                     |
| `nameOverride`                                           | Override the `name` of the chart.                                                                                                                                                                | `null`                                   |
| `fullnameOverride`                                       | Override the `fullname` of the chart.                                                                                                                                                            | `null`                                   |
| `commonLabels`                                           | Labels to add to all chart resources.                                                                                                                                                            | `{}`                                     |
| `serviceMonitor.enabled`                                 | If `true`, create a _Prometheus_ `ServiceMonitor` for each of the components.                                                                                                                    | `false`                                  |
| `serviceMonitor.additionalLabels`                        | Additional labels to be set on the `ServiceMonitor`.                                                                                                                                             | `{}`                                     |
| `serviceMonitor.endpointConfig`                          | Additional endpoint configuration for the `ServiceMonitor`.                                                                                                                                      | `{}`                                     |
| `logLevel`                                               | Log level to pass in to `klog`.                                                                                                                                                                  | `4`                                      |
| `admissionController.serviceAccount.create`              | If `true`, create a new `ServiceAccount` for the admission controller pod.                                                                                                                       | `true`                                   |
| `admissionController.serviceAccount.labels`              | Labels to add to the admission controller `ServiceAccount`.                                                                                                                                      | `{}`                                     |
| `admissionController.serviceAccount.annotations`         | Annotations to add to the admission controller `ServiceAccount`.                                                                                                                                 | `{}`                                     |
| `admissionController.serviceAccount.name`                | Name of the `ServiceAccount` to be used for the admission controller pod. If not set and `admissionController.serviceAccount.create` is `true` a name is generated using the full name template. | `null`                                   |
| `admissionController.service.annotations`                | Annotations to add to the admission controller `Service`.                                                                                                                                        | `{}`                                     |
| `admissionController.replicas`                           | The number of replicas of the admission controller pod.                                                                                                                                          | `1`                                      |
| `admissionController.updateStrategy`                     | Update strategy for the admission controller pod.                                                                                                                                                | `{}`                                     |
| `admissionController.podDisruptionBudget.enabled`        | If `true`, create a `PodDisruptionBudget` for the admission controller deployment.                                                                                                               | `{}`                                     |
| `admissionController.podDisruptionBudget.minAvailable`   | Set the admission controller PDB minimum available pods.                                                                                                                                         | `null`                                   |
| `admissionController.podDisruptionBudget.maxUnavailable` | Set the admission controller PDB maximum unavailable pods.                                                                                                                                       | `null`                                   |
| `admissionController.podLabels`                          | Labels to add to the admission controller pod.                                                                                                                                                   | `{}`                                     |
| `admissionController.podAnnotations`                     | Annotations to add to the admission controller pod.                                                                                                                                              | `{}`                                     |
| `admissionController.podSecurityContext`                 | Security context for the admission controller pod.                                                                                                                                               | `{runAsNonRoot: true, runAsUser: 65534}` |
| `admissionController.securityContext`                    | Security context for the _admission-controller_ container in the admission controller pod.                                                                                                       | `{}`                                     |
| `admissionController.priorityClassName`                  | Priority class name to use for the admission controller pod.                                                                                                                                     | `null`                                   |
| `admissionController.terminationGracePeriodSeconds`      | Termination grace period for the admission controller pod.                                                                                                                                       | `null`                                   |
| `admissionController.extraEnv`                           | Extra environment variables for the _admission-controller_ container in the admission controller pod.                                                                                            | `[]`                                     |
| `admissionController.extraArgs`                          | Extra arguments for the _admission-controller_ container in the admission controller pod.                                                                                                        | `[]`                                     |
| `admissionController.livenessProbe`                      | Liveness probe for the _admission-controller_ container in the admission controller pod.                                                                                                         | See _values.yaml_                        |
| `admissionController.readinessProbe`                     | Readiness probe for the _admission-controller_ container in the admission controller pod.                                                                                                        | See _values.yaml_                        |
| `admissionController.resources`                          | Resource requests and limits for the _admission-controller_ container in the admission controller pod.                                                                                           | `{}`                                     |
| `admissionController.nodeSelector`                       | Node labels for admission controller pod assignment.                                                                                                                                             | `{}`                                     |
| `admissionController.affinity`                           | Affinity settings for admission controller pod assignment. If an explicit label selector is not provided for pod affinity or pod anti-affinity one will be created from the pod selector labels. | `{}`                                     |
| `admissionController.topologySpreadConstraints`          | Topology spread constraints for admission controller pod assignment. If an explicit label selector is not provided one will be created from the pod selector labels.                             | `[]`                                     |
| `admissionController.tolerations`                        | Toleration labels for admission controller pod assignment.                                                                                                                                       | `[]`                                     |
| `admissionController.webhook.name`                       | Name of the admission controller webhook.                                                                                                                                                        | `vpa-webhook-config`                     |
| `admissionController.certManager.enabled`                | If `true`, use _Cert Manager_ to create and manage the certificates for the webhook.                                                                                                             | `false`                                  |
| `admissionController.certManager.issuerKind`             | The type of issuer that `admissionController.certManager.issuerName` refers to.                                                                                                                  | `Issuer`                                 |
| `admissionController.certManager.issuerName`             | If set, the _Cert Manager_ certificate will be configured to use this issuer.                                                                                                                    |
| `recommenderOnly`                                        | If `true`, only deploy the VPA recommender. This is useful if you're only wanting to use VPA for resource recommendations.                                                                       | `false`                                  |
| `recommender.serviceAccount.create`                      | If `true`, create a new `ServiceAccount` for the recommender pod.                                                                                                                                | `true`                                   |
| `recommender.serviceAccount.labels`                      | Labels to add to the recommender `ServiceAccount`.                                                                                                                                               | `{}`                                     |
| `recommender.serviceAccount.annotations`                 | Annotations to add to the recommender `ServiceAccount`.                                                                                                                                          | `{}`                                     |
| `recommender.serviceAccount.name`                        | Name of the `ServiceAccount` to be used for the recommender pod. If not set and `recommender.serviceAccount.create` is `true` a name is generated using the full name template.                  | `null`                                   |
| `recommender.service.annotations`                        | Annotations to add to the recommender `Service`.                                                                                                                                                 | `{}`                                     |
| `recommender.replicas`                                   | The number of replicas of the recommender pod.                                                                                                                                                   | `1`                                      |
| `recommender.updateStrategy`                             | Update strategy for the recommender pod.                                                                                                                                                         | `{}`                                     |
| `recommender.podDisruptionBudget.enabled`                | If `true`, create a `PodDisruptionBudget` for the recommender deployment.                                                                                                                        | `{}`                                     |
| `recommender.podDisruptionBudget.minAvailable`           | Set the recommender PDB minimum available pods.                                                                                                                                                  | `null`                                   |
| `recommender.podDisruptionBudget.maxUnavailable`         | Set the recommender PDB maximum unavailable pods.                                                                                                                                                | `null`                                   |
| `recommender.podLabels`                                  | Labels to add to the recommender pod.                                                                                                                                                            | `{}`                                     |
| `recommender.podAnnotations`                             | Annotations to add to the recommender pod.                                                                                                                                                       | `{}`                                     |
| `recommender.podSecurityContext`                         | Security context for the recommender pod.                                                                                                                                                        | `{runAsNonRoot: true, runAsUser: 65534}` |
| `recommender.securityContext`                            | Security context for the _recommender_ container in the recommender pod.                                                                                                                         | `{}`                                     |
| `recommender.priorityClassName`                          | Priority class name to use for the recommender pod.                                                                                                                                              | `null`                                   |
| `recommender.terminationGracePeriodSeconds`              | Termination grace period for the recommender pod.                                                                                                                                                | `null`                                   |
| `recommender.extraEnv`                                   | Extra environment variables for the _recommender_ container in the recommender pod.                                                                                                              | `[]`                                     |
| `recommender.extraArgs`                                  | Extra arguments for the _recommender_ container in the recommender pod.                                                                                                                          | `[]`                                     |
| `recommender.livenessProbe`                              | Liveness probe for the _recommender_ container in the recommender pod.                                                                                                                           | See _values.yaml_                        |
| `recommender.readinessProbe`                             | Readiness probe for the _recommender_ container in the recommender pod.                                                                                                                          | See _values.yaml_                        |
| `recommender.resources`                                  | Resource requests and limits for the _recommender_ container in the recommender pod.                                                                                                             | `{}`                                     |
| `recommender.nodeSelector`                               | Node labels for recommender pod assignment.                                                                                                                                                      | `{}`                                     |
| `recommender.affinity`                                   | Affinity settings for recommender pod assignment. If an explicit label selector is not provided for pod affinity or pod anti-affinity one will be created from the pod selector labels.          | `{}`                                     |
| `recommender.topologySpreadConstraints`                  | Topology spread constraints for recommender pod assignment. If an explicit label selector is not provided one will be created from the pod selector labels.                                      | `[]`                                     |
| `recommender.tolerations`                                | Toleration labels for recommender pod assignment.                                                                                                                                                | `[]`                                     |
| `updater.serviceAccount.create`                          | If `true`, create a new `ServiceAccount` for the updater pod.                                                                                                                                    | `true`                                   |
| `updater.serviceAccount.labels`                          | Labels to add to the updater `ServiceAccount`.                                                                                                                                                   | `{}`                                     |
| `updater.serviceAccount.annotations`                     | Annotations to add to the updater `ServiceAccount`.                                                                                                                                              | `{}`                                     |
| `updater.serviceAccount.name`                            | Name of the `ServiceAccount` to be used for the updater pod. If not set and `updater.serviceAccount.create` is `true` a name is generated using the full name template.                          | `null`                                   |
| `updater.service.annotations`                            | Annotations to add to the updater `Service`.                                                                                                                                                     | `{}`                                     |
| `updater.replicas`                                       | The number of replicas of the updater pod.                                                                                                                                                       | `1`                                      |
| `updater.updateStrategy`                                 | Update strategy for the updater pod.                                                                                                                                                             | `{}`                                     |
| `updater.podDisruptionBudget.enabled`                    | If `true`, create a `PodDisruptionBudget` for the updater deployment.                                                                                                                            | `{}`                                     |
| `updater.podDisruptionBudget.minAvailable`               | Set the updater PDB minimum available pods.                                                                                                                                                      | `null`                                   |
| `updater.podDisruptionBudget.maxUnavailable`             | Set the updater PDB maximum unavailable pods.                                                                                                                                                    | `null`                                   |
| `updater.podLabels`                                      | Labels to add to the updater pod.                                                                                                                                                                | `{}`                                     |
| `updater.podAnnotations`                                 | Annotations to add to the updater pod.                                                                                                                                                           | `{}`                                     |
| `updater.podSecurityContext`                             | Security context for the updater pod.                                                                                                                                                            | `{runAsNonRoot: true, runAsUser: 65534}` |
| `updater.securityContext`                                | Security context for the _updater_ container in the updater pod.                                                                                                                                 | `{}`                                     |
| `updater.priorityClassName`                              | Priority class name to use for the updater pod.                                                                                                                                                  | `null`                                   |
| `updater.terminationGracePeriodSeconds`                  | Termination grace period for the updater pod.                                                                                                                                                    | `null`                                   |
| `updater.extraEnv`                                       | Extra environment variables for the _updater_ container in the updater pod.                                                                                                                      | `[]`                                     |
| `updater.extraArgs`                                      | Extra arguments for the _updater_ container in the updater pod.                                                                                                                                  | `[]`                                     |
| `updater.livenessProbe`                                  | Liveness probe for the _updater_ container in the updater pod.                                                                                                                                   | See _values.yaml_                        |
| `updater.readinessProbe`                                 | Readiness probe for the _updater_ container in the updater pod.                                                                                                                                  | See _values.yaml_                        |
| `updater.resources`                                      | Resource requests and limits for the _updater_ container in the updater pod.                                                                                                                     | `{}`                                     |
| `updater.nodeSelector`                                   | Node labels for updater pod assignment.                                                                                                                                                          | `{}`                                     |
| `updater.affinity`                                       | Affinity settings for updater pod assignment. If an explicit label selector is not provided for pod affinity or pod anti-affinity one will be created from the pod selector labels.              | `{}`                                     |
| `updater.topologySpreadConstraints`                      | Topology spread constraints for updater pod assignment. If an explicit label selector is not provided one will be created from the pod selector labels.                                          | `[]`                                     |
| `updater.tolerations`                                    | Toleration labels for updater pod assignment.                                                                                                                                                    | `[]`                                     |
