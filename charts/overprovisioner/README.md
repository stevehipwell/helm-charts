# Overprovisioner

The _Overprovisioner_ chart is designed to overprovision a _Kubernetes_ cluster and is based on the _Cluster Autoscaler_ [documentation](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-configure-overprovisioning-with-cluster-autoscaler) but can be used in any dynamic scaling _Kubernetes_ cluster.

## Installing the Chart

Before you can install the chart you will need to add the `stevehipwell` repo to [Helm](https://helm.sh/).

```shell
helm repo add stevehipwell https://stevehipwell.github.io/helm-charts/
```

After you've installed the repo you can install the chart.

```shell
helm upgrade --install --namespace default --values ./my-values.yaml my-release stevehipwell/overprovisioner
```

## Configuration

The following table lists the configurable parameters of the _Overprovisioner_ chart and their default values.

| Parameter                                  | Description                                                                                                                                                                     | Default                                               |
| ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| `nameOverride`                             | Override the `name` of the chart.                                                                                                                                               |                                                       |
| `fullnameOverride`                         | Override the `fullname` of the chart.                                                                                                                                           |                                                       |
| `commonLabels`                             | Labels to add to all chart resources.                                                                                                                                           | `{}`                                                  |
| `imagePullSecrets`                         | Image pull secrets.                                                                                                                                                             | `[]`                                                  |
| `capacity.mode`                            | The mode to use for overprovisioning, if set to `auto` a cluster proportional autoscaler deployment will be used to scale the pause pods.                                       | `fixed`                                               |
| `capacity.fixed.replicas`                  | The number of pause pod replicas to create if `capacity.mode` is `fixed`.                                                                                                       | `1`                                                   |
| `capacity.auto.coresPerReplica`            | The number of pause pod replicas to create per core if `capacity.mode` is `auto`.                                                                                               | `4`                                                   |
| `capacity.auto.nodesPerReplica`            | The number of pause pod replicas to create per node if `capacity.mode` is `auto`.                                                                                               | `1`                                                   |
| `capacity.auto.minReplicas`                | The minimum number of pause pod replicas to create if `capacity.mode` is `auto`.                                                                                                | `1`                                                   |
| `capacity.auto.maxReplicas`                | The maximum number of pause pod replicas to create if `capacity.mode` is `auto`.                                                                                                | `1`                                                   |
| `capacity.resources.cpu`                   | The CPU requests/limits for the pause pods.                                                                                                                                     | `10m`                                                 |
| `capacity.resources.memory`                | The memory requests/limits for the pause pods.                                                                                                                                  | `16Mi`                                                |
| `priorityClass.create`                     | If `true`, create a new preemptible _PriorityClass_ to use for overprovisioning.                                                                                                | `true`                                                |
| `priorityClass.name`                       | Name to use for the preemptible priority class, if not set a name is generated using the chart full name.                                                                       |                                                       |
| `priorityClass.labels`                     | Labels to add to the priority class.                                                                                                                                            | `{}`                                                  |
| `priorityClass.annotations`                | Annotations to add to the priority class.                                                                                                                                       | `{}`                                                  |
| `priorityClass.value`                      | Value of the priority class, should be less then `0`.                                                                                                                           | `-1`                                                  |
| `pause.serviceAccount.create`              | If `true`, create a new _ServiceAccount_ for the pause pod.                                                                                                                     | `true`                                                |
| `pause.serviceAccount.name`                | Name to use for the pause pod service account, if not set a name is generated using the pause full name template.                                                               |                                                       |
| `pause.serviceAccount.labels`              | Labels to add to the pause service account.                                                                                                                                     | `{}`                                                  |
| `pause.serviceAccount.annotations`         | Annotations to add to the pause service account.                                                                                                                                | `{}`                                                  |
| `pause.image.repository`                   | Image repository.                                                                                                                                                               | `registry.k8s.io/pause`                               |
| `pause.image.tag`                          | Image tag.                                                                                                                                                                      | `3.9`                                                 |
| `pause.image.pullPolicy`                   | Image pull policy.                                                                                                                                                              | `IfNotPresent`                                        |
| `pause.podLabels`                          | Labels to add to the pause pod.                                                                                                                                                 | `{}`                                                  |
| `pause.podAnnotations`                     | Annotations to add to the pause pod.                                                                                                                                            | `{}`                                                  |
| `pause.nodeSelector`                       | Node label selector for the pause pod.                                                                                                                                          | `{}`                                                  |
| `pause.affinity`                           | Affinity settings for the pause pod. If an explicit label selector is not provided for pod affinity or pod anti-affinity one will be created from the pod selector labels.      | `{}`                                                  |
| `pause.topologySpreadConstraints`          | Topology spread constraints for the pause pod. If an explicit label selector is not provided one will be created from the pod selector labels.                                  | `[]`                                                  |
| `pause.tolerations`                        | Tolerations for the pause pod.                                                                                                                                                  | `[]`                                                  |
| `autoscaler.serviceAccount.create`         | If `true`, create a new _ServiceAccount_ for the autoscaler pod.                                                                                                                | `true`                                                |
| `autoscaler.serviceAccount.name`           | Name to use for the autoscaler pod service account, if not set a name is generated using the autoscaler full name template.                                                     |                                                       |
| `autoscaler.serviceAccount.labels`         | Labels to add to the autoscaler service account.                                                                                                                                | `{}`                                                  |
| `autoscaler.serviceAccount.annotations`    | Annotations to add to the autoscaler service account.                                                                                                                           | `{}`                                                  |
| `autoscaler.image.repository`              | Image repository.                                                                                                                                                               | `registry.k8s.io/cpa/cluster-proportional-autoscaler` |
| `autoscaler.image.tag`                     | Image tag.                                                                                                                                                                      | `1.8.6`                                               |
| `autoscaler.image.pullPolicy`              | Image pull policy.                                                                                                                                                              | `IfNotPresent`                                        |
| `autoscaler.podLabels`                     | Labels to add to the autoscaler pod.                                                                                                                                            | `{}`                                                  |
| `autoscaler.podAnnotations`                | Annotations to add to the autoscaler pod.                                                                                                                                       | `{}`                                                  |
| `autoscaler.podSecurityContext`            | Security context for the autoscaler pod.                                                                                                                                        | _See values.yaml_                                     |
| `autoscaler.securityContext`               | Security context for the _autoscaler_ container in the autoscaler pod.                                                                                                          | _See values.yaml_                                     |
| `autoscaler.priorityClassName`             | Priority class name to use for the autoscaler pod.                                                                                                                              |                                                       |
| `autoscaler.terminationGracePeriodSeconds` | Termination grace period for the autoscaler pod in seconds.                                                                                                                     | `0`                                                   |
| `autoscaler.resources`                     | Resource requests and limits for the autoscaler pod container.                                                                                                                  | `{}`                                                  |
| `autoscaler.nodeSelector`                  | Node label selector for the autoscaler pod.                                                                                                                                     | `{}`                                                  |
| `autoscaler.affinity`                      | Affinity settings for the autoscaler pod. If an explicit label selector is not provided for pod affinity or pod anti-affinity one will be created from the pod selector labels. | `{}`                                                  |
| `autoscaler.topologySpreadConstraints`     | Topology spread constraints for the autoscaler pod. If an explicit label selector is not provided one will be created from the pod selector labels.                             | `[]`                                                  |
| `autoscaler.tolerations`                   | Tolerations for the autoscaler pod.                                                                                                                                             | `[]`                                                  |
| `autoscaler.logLevel`                      | Log level for the autoscaler pod.                                                                                                                                               | `2`                                                   |
