apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "nexus3.commandsName" . }}
  labels:
    {{- include "nexus3.labels" . | nindent 4 }}
data:
  chown-volume-mounts.sh: |
    #!/usr/bin/env sh
    set -eu

    mkdir -p /nexus-data/etc

  update-ca-certs.sh: |
    #!/usr/bin/env sh
    set -eu

    mkdir -p /nexus-data/keystores
    cp -f "${JAVA_HOME}/jre/lib/security/cacerts" /nexus-data/keystores/cacerts

    for f in /nexus-data/secrets/cas/*
    do
      keytool -importcert -file "${f}" -alias "$(basename "${f}")" -keystore /nexus-data/keystores/cacerts -storepass changeit -trustcacerts -noprompt
    done

  download-plugins.sh: |
    #!/usr/bin/env sh
    set -eu

    rm -f /opt/sonatype/nexus/deploy/*

    {{- range $index, $val := .Values.installPlugins.plugins }}
    wget --no-check-certificate -O /opt/sonatype/nexus/deploy/{{ $val.name }}.kar {{ $val.url }}
    {{- end }}
