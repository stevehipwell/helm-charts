# Thanos

[Thanos](https://thanos.io/) is an open source, highly available _Prometheus_ setup with long term storage capabilities.

## Installing the Chart

Before you can install the chart you will need to add the `stevehipwell` repo to [Helm](https://helm.sh/).

```shell
helm repo add stevehipwell https://stevehipwell.github.io/helm-charts/
```

After you've installed the repo you can install the chart.

```shell
helm upgrade --install --namespace default --values ./my-values.yaml my-release stevehipwell/thanos
```

## Configuration

The following table lists the configurable parameters of the _Thanos_ chart and their default values.

| Parameter                                                     | Description                                                                                                                                                        | Default                                    |
| ------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------ |
| `image.repository`                                            | Image repository.                                                                                                                                                  | `quay.io/thanos/thanos`                    |
| `image.tag`                                                   | Image tag.                                                                                                                                                         | `v{{ .Chart.AppVersion }}`                 |
| `image.pullPolicy`                                            | Image pull policy.                                                                                                                                                 | `IfNotPresent`                             |
| `imagePullSecrets`                                            | Image pull secrets.                                                                                                                                                | `[]`                                       |
| `nameOverride`                                                | Override the `name` of the chart.                                                                                                                                  | `""`                                       |
| `fullnameOverride`                                            | Override the `fullname` of the chart.                                                                                                                              | `""`                                       |
| `serviceMonitor.enabled`                                      | If `true`, create a _Prometheus_ service monitor for all components.                                                                                               | `false`                                    |
| `serviceMonitor.additionalLabels`                             | Additional labels to be set on the ServiceMonitor.                                                                                                                 | `{}`                                       |
| `serviceMonitor.interval`                                     | _Prometheus_ scrape frequency.                                                                                                                                     | `1m`                                       |
| `objstoreConfig.create`                                       | If `true`, create a secret containing the content of `objstoreConfig.value`.                                                                                       | `true`                                     |
| `objstoreConfig.name`                                         | Name of an existing secret to use for the objstore configuration, this will also override the default secret name if set with `objstoreConfig.create: true`.       | `""`                                       |
| `objstoreConfig.key`                                          | Secret key to use for the objstore configuration.                                                                                                                  | `config`                                   |
| `objstoreConfig.value`                                        | Default objstore configuration, not suitible for production.                                                                                                       | _see values.yaml_                          |
| `logLevel`                                                    | Log level for all components.                                                                                                                                      | `info`                                     |
| `logFormat`                                                   | Log format for all components.                                                                                                                                     | `logfmt`                                   |
| `compact.enabled`                                             | If `true`, create resources for the compact component.                                                                                                             | `false`                                    |
| `compact.serviceAccount.create`                               | If `true`, create a new service account for the compact pod.                                                                                                       | `true`                                     |
| `compact.serviceAccount.annotations`                          | Annotations to add to the compact service account.                                                                                                                 | `{}`                                       |
| `compact.serviceAccount.name`                                 | Service account to be used for compact. If not set and `compact.serviceAccount.create` is `true`, a name is generated using the full name template.                | `""`                                       |
| `compact.updateStrategy`                                      | Update strategy for the compact pod.                                                                                                                               | `{}`                                       |
| `compact.podLabels`                                           | Labels to add to the compact pod.                                                                                                                                  | `{}`                                       |
| `compact.podAnnotations`                                      | Annotations to add to the compact pod.                                                                                                                             | `{}`                                       |
| `compact.podSecurityContext`                                  | Security context for the compact pod.                                                                                                                              | `{fsGroup: 65534, runAsUser: 65534}`       |
| `compact.securityContext`                                     | Security context for the _thanos-compact_ container in the compact pod.                                                                                            | `{}`                                       |
| `compact.priorityClassName`                                   | Priority class name to use for the compact pod.                                                                                                                    | `""`                                       |
| `compact.terminationGracePeriodSeconds`                       | Termination grace period for the compact pod.                                                                                                                      | `null`                                     |
| `compact.extraEnv`                                            | Extra environment variables for the _thanos-compact_ container in the compact pod.                                                                                 | `[]`                                       |
| `compact.extraArgs`                                           | Extra arguments for the _thanos-compact_ container in the compact pod.                                                                                             | `[]`                                       |
| `compact.livenessProbe`                                       | Liveness probe for the compact pod.                                                                                                                                | See _values.yaml_                          |
| `compact.readinessProbe`                                      | Readiness probe for the compact pod.                                                                                                                               | See _values.yaml_                          |
| `compact.resources`                                           | Resource requests and limits for the _thanos-compact_ container in the compact pod.                                                                                | `{}`                                       |
| `compact.persistence.enabled`                                 | If `true`, create a PVC for the compact pod.                                                                                                                       | `false`                                    |
| `compact.persistence.existingClaim`                           | Use an existing PVC to persist data for the compact pod.                                                                                                           | `""`                                       |
| `compact.persistence.annotations`                             | Annotations to add to the compact PVC.                                                                                                                             | `{}`                                       |
| `compact.persistence.accessMode`                              | Persistence access mode for the compact PVC.                                                                                                                       | `ReadWriteOnce`                            |
| `compact.persistence.storageClass`                            | Storage class for the compact PVC.                                                                                                                                 | `standard` _(use `-` for cluster default)_ |
| `compact.persistence.size`                                    | Size of the compact PVC.                                                                                                                                           | `8Gi`                                      |
| `compact.nodeSelector`                                        | Node labels for compact pod assignment.                                                                                                                            | `{}`                                       |
| `compact.tolerations`                                         | Toleration labels for compact pod assignment.                                                                                                                      | `[]`                                       |
| `compact.affinity`                                            | Affinity settings for compact pod assignment.                                                                                                                      | `{}`                                       |
| `query.serviceAccount.create`                                 | If `true`, create a new service account for the query pod.                                                                                                         | `true`                                     |
| `query.serviceAccount.annotations`                            | Annotations to add to the query service account.                                                                                                                   | `{}`                                       |
| `query.serviceAccount.name`                                   | Service account to be used for query. If not set and `query.serviceAccount.create` is `true`, a name is generated using the full name template.                    | `""`                                       |
| `query.replicas`                                              | The number of replicas of the query pod.                                                                                                                           | `1`                                        |
| `query.updateStrategy`                                        | Update strategy for the query pod.                                                                                                                                 | `{}`                                       |
| `query.autoscaling.enabled`                                   | If `true`, create a HPA for the query deployment.                                                                                                                  | `false`                                    |
| `query.autoscaling.minReplicas`                               | Minimum number of query pod replicas.                                                                                                                              | `1`                                        |
| `query.autoscaling.maxReplicas`                               | Maximum number of query pod replicas.                                                                                                                              | `3`                                        |
| `query.autoscaling.targetCPUUtilizationPercentage`            | Target CPU utilisation for the query pod.                                                                                                                          | `60`                                       |
| `query.autoscaling.targetMemoryUtilizationPercentage`         | Target memory utilisation for the query pod.                                                                                                                       | `60`                                       |
| `query.podDisruptionBudget.enabled`                           | If `true`, create a PDB for the query deployment.                                                                                                                  | `{}`                                       |
| `query.podDisruptionBudget.minAvailable`                      | Set the query PDB minimum available pods.                                                                                                                          | `null`                                     |
| `query.podDisruptionBudget.maxUnavailable`                    | Set the query PDB maximum unavailable pods.                                                                                                                        | `null`                                     |
| `query.podLabels`                                             | Labels to add to the query pod.                                                                                                                                    | `{}`                                       |
| `query.podAnnotations`                                        | Annotations to add to the query pod.                                                                                                                               | `{}`                                       |
| `query.podSecurityContext`                                    | Security context for the query pod.                                                                                                                                | `{fsGroup: 65534, runAsUser: 65534}`       |
| `query.securityContext`                                       | Security context for the _thanos-query_ container in the query pod.                                                                                                | `{}`                                       |
| `query.priorityClassName`                                     | Priority class name to use for the query pod.                                                                                                                      | `""`                                       |
| `query.terminationGracePeriodSeconds`                         | Termination grace period for the query pod.                                                                                                                        | `null`                                     |
| `query.extraEnv`                                              | Extra environment variables for the _thanos-query_ container in the query pod.                                                                                     | `[]`                                       |
| `query.replicaLabels`                                         | Labels added to metrics to show the replica recording the data.                                                                                                    | `[]`                                       |
| `query.sidecarService`                                        | Service address of the Thanos sidecar.                                                                                                                             | `""`                                       |
| `query.rulerServcie`                                          | Service address of the Thanos ruler component.                                                                                                                     | `""`                                       |
| `query.extraArgs`                                             | Extra arguments for the _thanos-query_ container in the query pod.                                                                                                 | `[]`                                       |
| `query.livenessProbe`                                         | Liveness probe for the query pod.                                                                                                                                  | See _values.yaml_                          |
| `query.readinessProbe`                                        | Readiness probe for the query pod.                                                                                                                                 | See _values.yaml_                          |
| `query.resources`                                             | Resource requests and limits for the _thanos-query_ container in the query pod.                                                                                    | `{}`                                       |
| `query.nodeSelector`                                          | Node labels for query pod assignment.                                                                                                                              | `{}`                                       |
| `query.tolerations`                                           | Toleration labels for query pod assignment.                                                                                                                        | `[]`                                       |
| `query.affinity`                                              | Affinity settings for query pod assignment.                                                                                                                        | `{}`                                       |
| `queryFrontend.enabled`                                       | If `true`, create resources for the query frontend component.                                                                                                      | `false`                                    |
| `queryFrontend.serviceAccount.create`                         | If `true`, create a new service account for the query frontend pod.                                                                                                | `true`                                     |
| `queryFrontend.serviceAccount.annotations`                    | Annotations to add to the query frontend service account.                                                                                                          | `{}`                                       |
| `queryFrontend.serviceAccount.name`                           | Service account to be used for query frontend. If not set and `queryFrontend.serviceAccount.create` is `true`, a name is generated using the full name template.   | `""`                                       |
| `queryFrontend.replicas`                                      | The number of replicas of the query frontend pod.                                                                                                                  | `1`                                        |
| `queryFrontend.updateStrategy`                                | Update strategy for the query frontend pod.                                                                                                                        | `{}`                                       |
| `queryFrontend.autoscaling.enabled`                           | If `true`, create a HPA for the query frontend deployment.                                                                                                         | `false`                                    |
| `queryFrontend.autoscaling.minReplicas`                       | Minimum number of query frontend pod replicas.                                                                                                                     | `1`                                        |
| `queryFrontend.autoscaling.maxReplicas`                       | Maximum number of query frontend pod replicas.                                                                                                                     | `3`                                        |
| `queryFrontend.autoscaling.targetCPUUtilizationPercentage`    | Target CPU utilisation for the query frontend pod.                                                                                                                 | `60`                                       |
| `queryFrontend.autoscaling.targetMemoryUtilizationPercentage` | Target memory utilisation for the query frontend pod.                                                                                                              | `60`                                       |
| `queryFrontend.podDisruptionBudget.enabled`                   | If `true`, create a PDB for the query frontend deployment.                                                                                                         | `{}`                                       |
| `queryFrontend.podDisruptionBudget.minAvailable`              | Set the query frontend PDB minimum available pods.                                                                                                                 | `null`                                     |
| `queryFrontend.podDisruptionBudget.maxUnavailable`            | Set the query frontend PDB maximum unavailable pods.                                                                                                               | `null`                                     |
| `queryFrontend.podLabels`                                     | Labels to add to the query frontend pod.                                                                                                                           | `{}`                                       |
| `queryFrontend.podAnnotations`                                | Annotations to add to the query frontend pod.                                                                                                                      | `{}`                                       |
| `queryFrontend.podSecurityContext`                            | Security context for the query frontend pod.                                                                                                                       | `{fsGroup: 65534, runAsUser: 65534}`       |
| `queryFrontend.securityContext`                               | Security context for the _thanos-query-frontend_ container in the query frontend pod.                                                                              | `{}`                                       |
| `queryFrontend.priorityClassName`                             | Priority class name to use for the query frontend pod.                                                                                                             | `""`                                       |
| `queryFrontend.terminationGracePeriodSeconds`                 | Termination grace period for the query frontend pod.                                                                                                               | `null`                                     |
| `queryFrontend.extraEnv`                                      | Extra environment variables for the _thanos-query-frontend_ container in the query frontend pod.                                                                   | `[]`                                       |
| `queryFrontend.extraArgs`                                     | Extra arguments for the _thanos-query-frontend_ container in the query frontend pod.                                                                               | `[]`                                       |
| `queryFrontend.livenessProbe`                                 | Liveness probe for the query frontend pod.                                                                                                                         | See _values.yaml_                          |
| `queryFrontend.readinessProbe`                                | Readiness probe for the query frontend pod.                                                                                                                        | See _values.yaml_                          |
| `queryFrontend.resources`                                     | Resource requests and limits for the _thanos-query-frontend_ container in the query frontend pod.                                                                  | `{}`                                       |
| `queryFrontend.nodeSelector`                                  | Node labels for query frontend pod assignment.                                                                                                                     | `{}`                                       |
| `queryFrontend.tolerations`                                   | Toleration labels for query frontend pod assignment.                                                                                                               | `[]`                                       |
| `queryFrontend.affinity`                                      | Affinity settings for query frontend pod assignment.                                                                                                               | `{}`                                       |
| `storeGateway.serviceAccount.create`                          | If `true`, create a new service account for the store gateway pod.                                                                                                 | `true`                                     |
| `storeGateway.serviceAccount.annotations`                     | Annotations to add to the store gateway service account.                                                                                                           | `{}`                                       |
| `storeGateway.serviceAccount.name`                            | Service account to be used for store gateway pod. If not set and `storeGateway.serviceAccount.create` is `true`, a name is generated using the full name template. | `""`                                       |
| `storeGateway.replicas`                                       | The number of replicas of the store gateway pod.                                                                                                                   | `1`                                        |
| `storeGateway.updateStrategy`                                 | Update strategy for the store gateway pod.                                                                                                                         | `{}`                                       |
| `storeGateway.podDisruptionBudget.enabled`                    | If `true`, create a PDB for the store gateway deployment.                                                                                                          | `{}`                                       |
| `storeGateway.podDisruptionBudget.minAvailable`               | Set the store gateway PDB minimum available pods.                                                                                                                  | `null`                                     |
| `storeGateway.podDisruptionBudget.maxUnavailable`             | Set the store gateway PDB maximum unavailable pods.                                                                                                                | `null`                                     |
| `storeGateway.podLabels`                                      | Labels to add to the store gateway pod.                                                                                                                            | `{}`                                       |
| `storeGateway.podAnnotations`                                 | Annotations to add to the store gateway pod.                                                                                                                       | `{}`                                       |
| `storeGateway.podSecurityContext`                             | Security context for the store gateway pod.                                                                                                                        | `{fsGroup: 65534, runAsUser: 65534}`       |
| `storeGateway.securityContext`                                | Security context for the _thanos-store-gateway_ container in the store gateway pod.                                                                                | `{}`                                       |
| `storeGateway.priorityClassName`                              | Priority class name to use for the store gateway pod.                                                                                                              | `""`                                       |
| `storeGateway.terminationGracePeriodSeconds`                  | Termination grace period for the store gateway pod.                                                                                                                | `null`                                     |
| `storeGateway.extraEnv`                                       | Extra environment variables for the _thanos-store-gateway_ container in the store gateway pod.                                                                     | `[]`                                       |
| `storeGateway.extraArgs`                                      | Extra arguments for the _thanos-store-gateway_ container in the store gateway pod.                                                                                 | `[]`                                       |
| `storeGateway.livenessProbe`                                  | Liveness probe for the store gateway pod.                                                                                                                          | See _values.yaml_                          |
| `storeGateway.readinessProbe`                                 | Readiness probe for the store gateway pod.                                                                                                                         | See _values.yaml_                          |
| `storeGateway.resources`                                      | Resource requests and limits for the _thanos-store-gateway_ container in the store gateway pod.                                                                    | `{}`                                       |
| `storeGateway.persistence.enabled`                            | If `true`, create a PVC for the store gateway pod.                                                                                                                 | `false`                                    |
| `storeGateway.persistence.existingClaim`                      | Use an existing PVC to persist data for the store gateway pod.                                                                                                     | `""`                                       |
| `storeGateway.persistence.annotations`                        | Annotations to add to the store gateway PVC.                                                                                                                       | `{}`                                       |
| `storeGateway.persistence.accessMode`                         | Persistence access mode for the store gateway PVC.                                                                                                                 | `ReadWriteOnce`                            |
| `storeGateway.persistence.storageClass`                       | Storage class for the store gateway PVC.                                                                                                                           | `standard` _(use `-` for cluster default)_ |
| `storeGateway.persistence.size`                               | Size of the store gateway PVC.                                                                                                                                     | `8Gi`                                      |
| `storeGateway.nodeSelector`                                   | Node labels for store gateway pod assignment.                                                                                                                      | `{}`                                       |
| `storeGateway.tolerations`                                    | Toleration labels for store gateway pod assignment.                                                                                                                | `[]`                                       |
| `storeGateway.affinity`                                       | Affinity settings for store gateway pod assignment.                                                                                                                | `{}`                                       |
